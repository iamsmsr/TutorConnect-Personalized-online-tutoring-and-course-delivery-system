<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tutor Dashboard - TutorConnect</title>
  <link rel="stylesheet" href="../css/index.css">
</head>
<body>
  <!-- Top Navigation Bar -->
  <div class="top-nav">
    <div class="nav-brand">
      <img src="../css/tutorconnect-logo.png" alt="TutorConnect Logo" class="course-logo">
      <h3>TutorConnect</h3>
    </div>
    <button id="logoutBtn" class="logout-btn">üö™ Log Out</button>
  </div>

  <div class="main-container">
    <!-- Main Dashboard -->
    <div id="mainDashboard">
      <div class="welcome-section">
        <h1>Welcome Back, Tutor! üë®‚Äçüè´</h1>
        <p>Your teaching control panel awaits</p>
      </div>
      <div class="dashboard-buttons">
        <button id="assignedCoursesBtn" class="dashboard-btn primary">
          <span class="btn-icon">üìö</span>
          <span class="btn-text">My Assigned Courses</span>
        </button>
        <button id="generateLinkBtn" class="dashboard-btn secondary">
          <span class="btn-icon">üîó</span>
          <span class="btn-text">Generate Link</span>
        </button>
        <button id="editProfileBtn" class="dashboard-btn tertiary">
          <span class="btn-icon">üë§</span>
          <span class="btn-text">Edit Profile</span>
        </button>
        <button id="chatBtn" class="dashboard-btn quaternary">
          <span class="btn-icon">üí¨</span>
          <span class="btn-text">Chat</span>
        </button>
      </div>
    </div>

    <!-- Assigned Courses Section -->
    <div id="assignedCoursesSection" style="display:none;">
      <div class="section-header">
        <h2>üìö My Assigned Courses</h2>
        <button id="backToMainFromCoursesBtn" class="back-btn">‚Üê Back to Dashboard</button>
      </div>
      <div class="admin-container">
        <div id="coursesList"></div>
      </div>
    </div>

    <!-- Course Details Section -->
    <div id="courseDetailsSection" style="display:none;">
      <div class="section-header">
        <h2 id="courseDetailsTitle">üìö Course Details</h2>
        <button id="backToCoursesBtn" class="back-btn">‚Üê Back to Courses</button>
      </div>
      <div class="course-action-buttons">
        <button id="enrolledStudentsBtn" class="course-action-btn primary">
          <span class="btn-icon">üë•</span>
          <span>Enrolled Students</span>
        </button>
        <button id="editResourcesBtn" class="course-action-btn secondary">
          <span class="btn-icon">üìù</span>
          <span>Edit/Add Resources</span>
        </button>
        <button id="sessionRequestsBtn" class="course-action-btn tertiary">
          <span class="btn-icon">üîî</span>
          <span>Session Requests</span>
        </button>
      </div>
      <div id="courseActionContent" class="admin-container"></div>
    </div>

    <!-- Generate Link Section -->
    <div id="generateLinkSection" style="display:none;">
      <div class="section-header">
        <h2>üîó Generate Jitsi Meet Link</h2>
        <button id="backToMainFromLinkBtn" class="back-btn">‚Üê Back to Dashboard</button>
      </div>
      <div class="admin-container">
        <div class="link-generator">
          <button id="generateJitsiBtn" class="generate-btn">Generate New Meeting Link</button>
          <div id="jitsiLinkContainer" class="link-display"></div>
        </div>
      </div>
    </div>

    <!-- Edit Profile Section -->
    <div id="editProfileSection" style="display:none;">
      <div class="section-header">
        <h2>üë§ Edit Profile</h2>
        <button id="backToMainFromProfileBtn" class="back-btn">‚Üê Back to Dashboard</button>
      </div>
      <div class="admin-container">
        <div id="profileEditContainer"></div>
        <div id="profileResult" style="text-align:center;margin-top:20px;"></div>
      </div>
    </div>
  </div>
  
  <script src="../js/tutor_dashboard.js"></script>
  <script src="../js/show_username.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .top-nav {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .nav-brand h3 {
      color: #667eea;
      font-weight: 700;
      font-size: 1.5rem;
      margin: 0;
    }

    .course-logo {
      width: 45px;
      height: 45px;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }

    .logout-btn:hover {
      background: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
    }

    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .welcome-section {
      text-align: center;
      margin-bottom: 50px;
      color: white;
    }

    .welcome-section h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .welcome-section p {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .dashboard-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin: 40px 0;
    }

    .dashboard-btn {
      background: rgba(255, 255, 255, 0.95);
      border: none;
      border-radius: 20px;
      padding: 30px 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      min-height: 120px;
    }

    .dashboard-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    }

    .dashboard-btn.primary { border-left: 5px solid #27ae60; }
    .dashboard-btn.secondary { border-left: 5px solid #3498db; }
    .dashboard-btn.tertiary { border-left: 5px solid #e67e22; }
    .dashboard-btn.quaternary { border-left: 5px solid #9b59b6; }

    .btn-icon {
      font-size: 2.5rem;
    }

    .btn-text {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c3e50;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .section-header h2 {
      color: #2c3e50;
      font-size: 1.8rem;
      font-weight: 600;
    }

    .back-btn {
      background: #95a5a6;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .back-btn:hover {
      background: #7f8c8d;
      transform: translateX(-3px);
    }

    .admin-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      min-height: 400px;
    }

    .course-action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .course-action-btn {
      background: rgba(255, 255, 255, 0.95);
      border: none;
      border-radius: 15px;
      padding: 20px 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      min-height: 80px;
    }

    .course-action-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .course-action-btn.primary { border-left: 5px solid #27ae60; }
    .course-action-btn.secondary { border-left: 5px solid #3498db; }
    .course-action-btn.tertiary { border-left: 5px solid #e67e22; }

    .course-action-btn .btn-icon {
      font-size: 1.8rem;
    }

    .course-action-btn span:last-child {
      font-size: 1rem;
      font-weight: 600;
      color: #2c3e50;
    }

    .link-generator {
      text-align: center;
      padding: 40px 20px;
    }

    .generate-btn {
      background: #3498db;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 15px 30px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .generate-btn:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }

    .link-display {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      border: 2px solid #e9ecef;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: monospace;
      font-size: 0.9rem;
    }

    /* Course list styling */
    .course-item {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 5px solid #3498db;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .course-item:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .course-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .course-description {
      color: #7f8c8d;
      margin-bottom: 10px;
    }

    .student-count {
      font-size: 0.9rem;
      color: #27ae60;
      font-weight: 500;
    }

    /* Form styling */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ecf0f1;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #fff;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
    }

    .btn-submit {
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 15px 30px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .btn-submit:hover {
      background: #229954;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
    }

    /* Tables styling */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }

    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #ecf0f1;
    }

    th {
      background: #3498db;
      color: white;
      font-weight: 600;
    }

    tr:hover {
      background: #f8f9fa;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .main-container {
        padding: 20px 15px;
      }
      
      .welcome-section h1 {
        font-size: 2rem;
      }
      
      .dashboard-buttons {
        grid-template-columns: 1fr;
      }
      
      .section-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .course-action-buttons {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script>
    // Tutor Dashboard Navigation - Exactly like student dashboard
    document.addEventListener('DOMContentLoaded', function() {
      initializeTutorDashboard();
    });

    function initializeTutorDashboard() {
      setupTutorNavigation();
    }

    function setupTutorNavigation() {
      // Assigned Courses button
      document.getElementById('assignedCoursesBtn').addEventListener('click', function() {
        showTutorSection('assignedCoursesSection');
        loadAssignedCourses();
      });

      // Generate Link button
      document.getElementById('generateLinkBtn').addEventListener('click', function() {
        showTutorSection('generateLinkSection');
        setupLinkGenerator();
      });

      // Edit Profile button
      document.getElementById('editProfileBtn').addEventListener('click', function() {
        showTutorSection('editProfileSection');
        loadEditProfileForm();
      });

      // Chat button
      document.getElementById('chatBtn').addEventListener('click', function() {
        window.location.href = 'chat.html';
      });

      // Logout button
      document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('jwt');
        window.location.href = 'login.html';
      });

      // Back navigation buttons
      document.getElementById('backToMainFromCoursesBtn').addEventListener('click', function() {
        showTutorSection('mainDashboard');
      });

      document.getElementById('backToMainFromLinkBtn').addEventListener('click', function() {
        showTutorSection('mainDashboard');
      });

      document.getElementById('backToMainFromProfileBtn').addEventListener('click', function() {
        showTutorSection('mainDashboard');
      });

      document.getElementById('backToCoursesBtn').addEventListener('click', function() {
        showTutorSection('assignedCoursesSection');
        loadAssignedCourses();
      });

      // Course action buttons
      document.getElementById('enrolledStudentsBtn').addEventListener('click', function() {
        loadEnrolledStudents();
      });

      document.getElementById('editResourcesBtn').addEventListener('click', function() {
        loadEditResources();
      });

      document.getElementById('sessionRequestsBtn').addEventListener('click', function() {
        loadSessionRequests();
      });
    }

    function showTutorSection(sectionId) {
      // Hide all sections
      const sections = ['mainDashboard', 'assignedCoursesSection', 'courseDetailsSection', 'generateLinkSection', 'editProfileSection'];
      sections.forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
      
      // Show the requested section
      document.getElementById(sectionId).style.display = 'block';
    }

    let currentCourseId = null;
    let currentCourseTitle = '';

    function loadAssignedCourses() {
      if (typeof showAssignedCourses === 'function') {
        // Override the original function to use our modern interface
        const originalShow = showAssignedCourses;
        window.showAssignedCourses = function() {
          const token = localStorage.getItem('jwt');
          if (!token) {
            alert('You are not logged in. Please log in first.');
            window.location.href = 'login.html';
            return;
          }
          
          fetch('http://localhost:8080/api/tutor/courses', {
            headers: { 'Authorization': 'Bearer ' + token }
          })
            .then(res => {
              if (res.status === 401) {
                alert('Session expired or unauthorized. Please log in again.');
                window.location.href = 'login.html';
                return Promise.reject('Unauthorized');
              }
              return res.json();
            })
            .then(courses => {
              if (!Array.isArray(courses)) return;
              
              let html = '';
              if (courses.length === 0) {
                html = '<p style="text-align: center; color: #7f8c8d; font-size: 1.1rem; margin: 40px 0;">No courses assigned yet.</p>';
              } else {
                courses.forEach(course => {
                  const studentCount = course.extra && course.extra.students ? course.extra.students.length : 0;
                  html += `
                    <div class="course-item" onclick="openCourseDetails('${course.id}', '${course.title.replace(/'/g, "\\'")}')">
                      <div class="course-title">${course.title}</div>
                      <div class="course-description">${course.description || 'No description available'}</div>
                      <div class="student-count">üë• ${studentCount} student${studentCount !== 1 ? 's' : ''} enrolled</div>
                    </div>
                  `;
                });
              }
              
              document.getElementById('coursesList').innerHTML = html;
            })
            .catch(err => {
              if (err !== 'Unauthorized') {
                document.getElementById('coursesList').innerHTML = '<p style="text-align: center; color: #e74c3c;">Error loading courses. Please try again.</p>';
              }
              console.error(err);
            });
        };
        
        showAssignedCourses();
        // Restore original function
        window.showAssignedCourses = originalShow;
      }
    }

    function openCourseDetails(courseId, courseTitle) {
      currentCourseId = courseId;
      currentCourseTitle = courseTitle;
      document.getElementById('courseDetailsTitle').textContent = `üìö ${courseTitle}`;
      showTutorSection('courseDetailsSection');
      document.getElementById('courseActionContent').innerHTML = '<p style="text-align: center; color: #7f8c8d; margin: 40px 0;">Select an action above to get started.</p>';
    }

    function loadEnrolledStudents() {
      if (!currentCourseId) return;
      
      const content = document.getElementById('courseActionContent');
      content.innerHTML = '<div style="text-align: center; margin: 40px 0;"><div class="spinner"></div><p>Loading enrolled students...</p></div>';
      
      // Use the existing functionality but render in our modern interface
      const token = localStorage.getItem('jwt');
      fetch('http://localhost:8080/api/tutor/courses', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
        .then(res => res.json())
        .then(courses => {
          const course = courses.find(c => c.id === currentCourseId);
          if (!course) {
            content.innerHTML = '<p style="text-align: center; color: #e74c3c;">Course not found.</p>';
            return;
          }
          
          let html = '<h3 style="color: #2c3e50; margin-bottom: 20px;">Enrolled Students & Assignments</h3>';
          
          if (!course.extra || !course.extra.students || course.extra.students.length === 0) {
            html += '<p style="text-align: center; color: #7f8c8d; margin: 40px 0;">No students enrolled yet.</p>';
          } else {
            html += '<div class="students-list">';
            course.extra.students.forEach((student, index) => {
              html += `
                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                  <h4 style="color: #2c3e50; margin-bottom: 10px;">üë§ ${student.name || student.email}</h4>
              `;
              
              if (course.extra.assignments && course.extra.assignments.length > 0) {
                html += '<div style="margin-top: 15px;"><strong>Assignments:</strong><ul style="margin-top: 10px;">';
                course.extra.assignments.forEach(([title, link]) => {
                  const doneAssignments = Array.isArray(student.assignmentsDone) ? student.assignmentsDone : [];
                  const isDone = doneAssignments.includes(title);
                  html += `
                    <li style="margin: 8px 0; padding: 10px; background: ${isDone ? '#e8f5e8' : '#fff3cd'}; border-radius: 8px; border-left: 4px solid ${isDone ? '#27ae60' : '#f39c12'};">
                      <strong>${title}:</strong> <a href="${link}" target="_blank" style="color: #3498db; text-decoration: none;">${link}</a>
                      <label style="margin-left: 15px; display: inline-flex; align-items: center; gap: 5px;">
                        <input type="checkbox" data-course="${course.id}" data-student="${student.email}" data-assignment="${title}" ${isDone ? 'checked' : ''} onchange="markAssignmentDone(this)" style="transform: scale(1.2);">
                        <span style="color: ${isDone ? '#27ae60' : '#f39c12'}; font-weight: 500;">${isDone ? 'Completed' : 'Pending'}</span>
                      </label>
                    </li>
                  `;
                });
                html += '</ul></div>';
              } else {
                html += '<p style="color: #7f8c8d; font-style: italic; margin-top: 10px;">No assignments available for this course.</p>';
              }
              
              html += '</div>';
            });
            html += '</div>';
          }
          
          content.innerHTML = html;
        })
        .catch(err => {
          content.innerHTML = '<p style="text-align: center; color: #e74c3c;">Error loading students. Please try again.</p>';
          console.error(err);
        });
    }

    function loadEditResources() {
      if (!currentCourseId) return;
      
      const content = document.getElementById('courseActionContent');
      content.innerHTML = '<div style="text-align: center; margin: 40px 0;"><div class="spinner"></div><p>Loading resources...</p></div>';
      
      // Load the existing edit resources functionality but with modern styling
      const token = localStorage.getItem('jwt');
      fetch('http://localhost:8080/api/tutor/courses', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
        .then(res => res.json())
        .then(courses => {
          const course = courses.find(c => c.id === currentCourseId);
          if (!course) {
            content.innerHTML = '<p style="text-align: center; color: #e74c3c;">Course not found.</p>';
            return;
          }
          
          // Generate form with existing functionality but modern styling
          let html = `<h3 style="color: #2c3e50; margin-bottom: 20px;">Edit/Add Resources for ${course.title}</h3>`;
          html += `<form onsubmit="return submitResourceForm(event, '${course.id}')" id="resourceForm_${course.id}" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">`;
          
          // Videos section
          html += '<div class="form-group"><label>üìπ Videos:</label>';
          html += `<div id="videoFields_${course.id}">`;
          if (course.extra && course.extra.video) {
            course.extra.video.forEach(([title, link]) => {
              html += `<div class="video-field" style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" name="videoTitle" placeholder="Video Title" value="${title}" style="flex: 1;">
                <input type="text" name="videoLink" placeholder="YouTube Link" value="${link}" style="flex: 2;">
              </div>`;
            });
          }
          html += '</div>';
          html += `<button type="button" onclick="addVideoField('${course.id}')" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 20px; margin-top: 10px; cursor: pointer;">+ Add Video</button></div>`;
          
          // Documents section
          html += '<div class="form-group"><label>üìÑ Documents:</label>';
          html += `<div id="docFields_${course.id}">`;
          if (course.extra && course.extra.docs) {
            course.extra.docs.forEach(([title, link]) => {
              html += `<div class="doc-field" style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" name="docTitle" placeholder="Document Title" value="${title}" style="flex: 1;">
                <input type="text" name="docLink" placeholder="Document Link" value="${link}" style="flex: 2;">
              </div>`;
            });
          }
          html += '</div>';
          html += `<button type="button" onclick="addDocField('${course.id}')" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 20px; margin-top: 10px; cursor: pointer;">+ Add Document</button></div>`;
          
          // Assignments section
          html += '<div class="form-group"><label>üìù Assignments:</label>';
          html += `<div id="assignmentFields_${course.id}">`;
          if (course.extra && course.extra.assignments) {
            course.extra.assignments.forEach(([title, link]) => {
              html += `<div class="assignment-field" style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" name="assignmentTitle" placeholder="Assignment Title" value="${title}" style="flex: 1;">
                <input type="text" name="assignmentLink" placeholder="Assignment Link" value="${link}" style="flex: 2;">
              </div>`;
            });
          }
          html += '</div>';
          html += `<button type="button" onclick="addAssignmentField('${course.id}')" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 20px; margin-top: 10px; cursor: pointer;">+ Add Assignment</button></div>`;
          
          // Quizzes section
          html += '<div class="form-group"><label>üß† Quizzes:</label>';
          html += `<div id="quizFields_${course.id}">`;
          if (course.extra && course.extra.quizzes) {
            course.extra.quizzes.forEach((quiz) => {
              html += `<div class="quiz-field" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <input type="text" name="quizQuestion" value="${quiz.question || ''}" placeholder="Quiz Question" style="width: 100%; margin-bottom: 10px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                  <input type="text" name="quizOption" value="${quiz.options?.[0] || ''}" placeholder="Option 1">
                  <input type="text" name="quizOption" value="${quiz.options?.[1] || ''}" placeholder="Option 2">
                  <input type="text" name="quizOption" value="${quiz.options?.[2] || ''}" placeholder="Option 3">
                  <input type="text" name="quizOption" value="${quiz.options?.[3] || ''}" placeholder="Option 4">
                </div>
                <input type="text" name="quizAnswer" value="${quiz.answer || ''}" placeholder="Correct Answer" style="width: 100%; margin-bottom: 10px;">
                <button type="button" onclick="this.parentNode.remove()" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 15px; cursor: pointer;">Remove Quiz</button>
              </div>`;
            });
          }
          html += '</div>';
          html += `<button type="button" onclick="addQuizField('${course.id}')" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 20px; margin-top: 10px; cursor: pointer;">+ Add Quiz</button></div>`;
          
          html += '<button type="submit" class="btn-submit">üíæ Save Resources</button>';
          html += '</form>';
          html += `<div id="resourceResult_${course.id}" style="text-align: center; margin-top: 20px; font-weight: 500;"></div>`;
          
          content.innerHTML = html;
        })
        .catch(err => {
          content.innerHTML = '<p style="text-align: center; color: #e74c3c;">Error loading resources. Please try again.</p>';
          console.error(err);
        });
    }

    function loadSessionRequests() {
      if (!currentCourseId) return;
      
      const content = document.getElementById('courseActionContent');
      content.innerHTML = '<div style="text-align: center; margin: 40px 0;"><div class="spinner"></div><p>Loading session requests...</p></div>';
      
      const token = localStorage.getItem('jwt');
      fetch(`http://localhost:8080/api/courses/${currentCourseId}/tutor-requests`, {
        headers: { 'Authorization': 'Bearer ' + token }
      })
        .then(res => res.json())
        .then(data => {
          if (!data.success) {
            content.innerHTML = '<p style="text-align: center; color: #e74c3c;">Error loading session requests.</p>';
            return;
          }
          
          const requests = data.requests || [];
          let html = '<h3 style="color: #2c3e50; margin-bottom: 20px;">Session Requests</h3>';
          
          if (requests.length === 0) {
            html += '<p style="text-align: center; color: #7f8c8d; margin: 40px 0;">No session requests yet.</p>';
          } else {
            requests.forEach((r, index) => {
              const statusColor = r.status === 'accepted' ? '#27ae60' : 
                                 r.status === 'rejected' ? '#e74c3c' : 
                                 r.status === 'done' ? '#3498db' : '#f39c12';
              const bgColor = r.status === 'accepted' ? '#e8f5e8' : 
                             r.status === 'rejected' ? '#ffeaea' : 
                             r.status === 'done' ? '#e8f4f8' : '#fff8e1';
              
              html += `
                <div style="background: ${bgColor}; border: 2px solid ${statusColor}; border-radius: 15px; padding: 20px; margin-bottom: 15px; ${r.isExtra ? 'border-left: 6px solid #ff9800;' : ''}">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <h4 style="color: #2c3e50; margin: 0;">
                      ${r.isExtra ? 'üî∂ EXTRA ' : ''}Request #${index + 1}
                    </h4>
                    <span style="background: ${statusColor}; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">
                      ${r.status.toUpperCase()}
                    </span>
                  </div>
                  <p style="margin-bottom: 10px;"><strong>From:</strong> ${r.studentEmail}</p>
                  ${r.isExtra ? '<p style="color: #ff9800; font-weight: bold; font-size: 0.9rem; margin-bottom: 15px;">‚ö†Ô∏è This is an extra request beyond the 5-request limit</p>' : ''}
              `;
              
              if (r.status === 'pending') {
                html += `
                  <div style="background: white; padding: 15px; border-radius: 10px; margin-top: 15px;">
                    <div class="form-group">
                      <label>üìÖ Schedule Date & Time:</label>
                      <input type="datetime-local" id="schedule_${r.id}" style="width: 100%;">
                    </div>
                    <div class="form-group">
                      <label>üí¨ Message for Student (Optional):</label>
                      <textarea id="comment_${r.id}" placeholder="${r.isExtra ? 'Consider explaining why you are accepting/rejecting this extra request...' : 'Optional message for student...'}" style="width: 100%; height: 80px; resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                      <button class="acceptSessionBtn" data-course="${currentCourseId}" data-id="${r.id}" data-student="${r.studentEmail}" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 600;">‚úì Accept & Send Jitsi</button>
                      <button class="rejectSessionBtn" data-course="${currentCourseId}" data-id="${r.id}" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 600;">‚úó Reject</button>
                    </div>
                  </div>
                `;
              } else if (r.status === 'accepted' && r.scheduledTime) {
                html += `<p><strong>üìÖ Scheduled:</strong> ${new Date(r.scheduledTime).toLocaleString()}</p>`;
                if (r.jitsiLink) {
                  html += `<p><strong>üîó Meeting Link:</strong> <a href="${r.jitsiLink}" target="_blank" style="color: #3498db; text-decoration: none;">${r.jitsiLink}</a></p>`;
                }
                if (r.comment) {
                  html += `<p><strong>üí¨ Message:</strong> ${r.comment}</p>`;
                }
              }
              
              html += '</div>';
            });
          }
          
          content.innerHTML = html;
          
          // Add event listeners for accept/reject buttons
          content.querySelectorAll('.acceptSessionBtn').forEach(btn => {
            btn.addEventListener('click', function() {
              acceptSessionRequest(this);
            });
          });
          
          content.querySelectorAll('.rejectSessionBtn').forEach(btn => {
            btn.addEventListener('click', function() {
              rejectSessionRequest(this);
            });
          });
        })
        .catch(err => {
          content.innerHTML = '<p style="text-align: center; color: #e74c3c;">Error loading session requests. Please try again.</p>';
          console.error(err);
        });
    }

    function setupLinkGenerator() {
      document.getElementById('generateJitsiBtn').addEventListener('click', function() {
        const randomStr = Math.random().toString(36).substring(2, 8);
        const roomName = `TutorConnect_${Date.now()}_${randomStr}`;
        const jitsiLink = `https://meet.jit.si/${roomName}`;
        
        const linkContainer = document.getElementById('jitsiLinkContainer');
        linkContainer.innerHTML = `
          <div style="text-align: center;">
            <p style="margin-bottom: 15px; color: #27ae60; font-weight: 600;">‚úÖ Meeting link generated successfully!</p>
            <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #27ae60; margin-bottom: 15px;">
              <p style="margin: 0; word-break: break-all;">
                <a href="${jitsiLink}" target="_blank" style="color: #3498db; text-decoration: none; font-weight: 500;">${jitsiLink}</a>
              </p>
            </div>
            <button onclick="copyToClipboard('${jitsiLink}')" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 500;">üìã Copy Link</button>
          </div>
        `;
      });
    }

    function loadEditProfileForm() {
      if (typeof showEditProfileForm === 'function') {
        // Override the original function to use our modern interface
        const originalShow = showEditProfileForm;
        window.showEditProfileForm = function() {
          // Create modern styled profile edit form
          const formHtml = `
            <form id="editProfileForm" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
              <h3 style="color: #2c3e50; margin-bottom: 20px;">Edit Your Profile</h3>
              <div class="form-group">
                <label>üë§ Username:</label>
                <input type="text" name="username" placeholder="Enter your username" required>
              </div>
              <div class="form-group">
                <label>üìß Email:</label>
                <input type="email" name="email" placeholder="Enter your email" required>
              </div>
              <div class="form-group">
                <label>üìù Bio:</label>
                <textarea name="bio" placeholder="Tell us about yourself" rows="4"></textarea>
              </div>
              <div class="form-group">
                <label>üìö Subjects (comma separated):</label>
                <input type="text" name="subjects" placeholder="e.g., Mathematics, Physics, Chemistry">
              </div>
              <div class="form-group">
                <label>üåç Languages (comma separated):</label>
                <input type="text" name="languages" placeholder="e.g., English, Spanish, French">
              </div>
              <div class="form-group">
                <label>‚è∞ Availability:</label>
                <input type="text" name="availability" placeholder="e.g., Mon-Fri 9AM-5PM">
              </div>
              <button type="submit" class="btn-submit">üíæ Update Profile</button>
            </form>
          `;
          
          document.getElementById('profileEditContainer').innerHTML = formHtml;
          document.getElementById('profileResult').textContent = '';
          
          // Handle form submission with modern styling
          document.getElementById('editProfileForm').onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const token = localStorage.getItem('jwt');
            const resultDiv = document.getElementById('profileResult');
            
            const data = {
              username: form.username.value,
              email: form.email.value,
              bio: form.bio.value,
              subjects: form.subjects.value.split(',').map(s => s.trim()).filter(s => s),
              languages: form.languages.value.split(',').map(l => l.trim()).filter(l => l),
              availability: form.availability.value
            };
            
            try {
              const res = await fetch('http://localhost:8080/api/tutor/profile', {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(data)
              });
              
              let result;
              if (res.ok) {
                result = await res.json();
                resultDiv.textContent = result.success ? '‚úÖ Profile updated successfully!' : (result.message || 'Error updating profile');
                resultDiv.style.color = result.success ? '#27ae60' : '#e74c3c';
                resultDiv.style.fontWeight = '600';
              } else {
                try {
                  result = await res.json();
                  resultDiv.textContent = '‚ùå ' + (result.message || 'Error: ' + res.status);
                } catch {
                  resultDiv.textContent = '‚ùå Error: ' + res.status;
                }
                resultDiv.style.color = '#e74c3c';
                resultDiv.style.fontWeight = '600';
              }
            } catch (error) {
              resultDiv.textContent = '‚ùå Network error occurred';
              resultDiv.style.color = '#e74c3c';
              resultDiv.style.fontWeight = '600';
            }
          };
        };
        
        showEditProfileForm();
        // Restore original function
        window.showEditProfileForm = originalShow;
      }
    }

    // Utility functions
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(function() {
        alert('Link copied to clipboard!');
      }).catch(function() {
        alert('Failed to copy link. Please copy manually.');
      });
    }

    function acceptSessionRequest(button) {
      const courseId = button.getAttribute('data-course');
      const requestId = button.getAttribute('data-id');
      const studentEmail = button.getAttribute('data-student');
      const scheduleInput = document.getElementById(`schedule_${requestId}`);
      const commentInput = document.getElementById(`comment_${requestId}`);
      
      if (!scheduleInput.value) {
        alert('Please select a date and time for the session.');
        return;
      }
      
      // Generate Jitsi link
      const randomStr = Math.random().toString(36).substring(2, 8);
      const roomName = `TC_${courseId}_${studentEmail.replace(/[^a-zA-Z0-9]/g,'')}_${randomStr}`;
      const jitsiLink = `https://meet.jit.si/${roomName}`;
      
      const token = localStorage.getItem('jwt');
      const data = {
        action: 'accept',
        scheduledTime: scheduleInput.value,
        comment: commentInput.value,
        jitsiLink: jitsiLink
      };
      
      fetch(`http://localhost:8080/api/courses/${courseId}/tutor-requests/${requestId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          alert('Session request accepted successfully!');
          loadSessionRequests(); // Refresh the list
        } else {
          alert(result.message || 'Error accepting request');
        }
      })
      .catch(err => {
        alert('Network error occurred');
        console.error(err);
      });
    }

    function rejectSessionRequest(button) {
      const courseId = button.getAttribute('data-course');
      const requestId = button.getAttribute('data-id');
      const commentInput = document.getElementById(`comment_${requestId}`);
      
      const token = localStorage.getItem('jwt');
      const data = {
        action: 'reject',
        comment: commentInput.value
      };
      
      fetch(`http://localhost:8080/api/courses/${courseId}/tutor-requests/${requestId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          alert('Session request rejected.');
          loadSessionRequests(); // Refresh the list
        } else {
          alert(result.message || 'Error rejecting request');
        }
      })
      .catch(err => {
        alert('Network error occurred');
        console.error(err);
      });
    }
  </script>
</body>
</html>
